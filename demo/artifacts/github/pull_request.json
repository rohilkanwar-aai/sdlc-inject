{
  "id": 9400001,
  "number": 9396,
  "title": "fix: resolve race condition in buffer lock acquisition",
  "body": "## Summary\n\nFixes #3323\n\nThis PR resolves a TOCTOU (Time-of-check to time-of-use) race condition in buffer lock acquisition that was causing conflicts when multiple users tried to open the same file simultaneously.\n\n## Changes\n\n- `crates/collab/src/db/buffers.rs`\n- `crates/collab/src/db/mod.rs`\n\n## Root Cause\n\nThe previous implementation had a race window:\n1. Check if buffer is available (Query 1)\n2. If available, acquire lock (Query 2)\n\nBetween these two operations, another request could acquire the lock.\n\n## Solution\n\nReplace the two-step process with an atomic operation:\n```sql\nUPDATE buffers SET locked_by = $1\nWHERE id = $2 AND locked_by IS NULL\nRETURNING id\n```\n\n## Testing\n\n- [x] Added concurrent acquisition test\n- [x] Existing tests pass\n- [x] Manual testing with 2 clients\n\n## Checklist\n\n- [x] Code follows project conventions\n- [x] Tests added/updated\n- [x] Documentation updated (if needed)\n",
  "state": "open",
  "draft": false,
  "user": {
    "login": "oncall-engineer"
  },
  "head": {
    "ref": "fix/buffer-lock-race-965"
  },
  "base": {
    "ref": "main"
  },
  "labels": [
    {
      "name": "bug-fix",
      "color": "00ff00"
    },
    {
      "name": "distributed-system-failures",
      "color": "0366d6"
    }
  ],
  "created_at": "2026-02-05T19:39:25.398049Z",
  "updated_at": "2026-02-05T20:02:25.398049Z",
  "mergeable": true,
  "additions": 99,
  "deletions": 30,
  "changed_files": 2,
  "html_url": "https://github.com/org/zed/pull/7149"
}