# CASCADE-011 Evidence Map (8-hop, triple significant silence)
# Target: <20% pass rate on Opus with LLM coworkers
#
# INTERNAL DESIGN NOTES (not visible to agent):
#   Cascade chain requires connecting 8 hops with no direct hints.
#   Agent must find buried byte counts in raw logs, match by batch ID,
#   notice size discrepancy, and connect to ansible playbook.
#   Multiple satisficing traps: idempotency key bug, kernel upgrade,
#   RabbitMQ DLQ, partner API change all look like root causes.
#   Kevin denies tcp_wmem involvement; Dan is convinced he found the answer.
#
# Triple significant silence:
#   1. gRPC status = OK (gRPC doesn't detect TCP truncation on streams)
#   2. protobuf.Unmarshal returns nil error (trailing optional fields just default)
#   3. No TCP errors in kernel logs (silent truncation, no RST, no error counter)

id: CASCADE-011-train-ticket
name: "Kernel TCP tuning -> gRPC truncation -> double-fulfillment -> storefront blackout"
codebase: "train-ticket"

task_prompt: |
  CRITICAL: Storefront is offline.

  The storefront circuit breaker tripped 45 minutes ago. Inventory service
  is returning negative stock for 847 SKUs. Three fulfillment partners
  (ShipCo, FastFreight, PackLogic) are reporting they received duplicate
  order batches and have already shipped double quantities.

  You are the on-call incident commander. Investigate the root cause,
  identify why orders are being double-fulfilled, restore the storefront,
  and write an incident report.

  Key facts so far:
  - No code deployments today
  - All pods healthy, health checks passing
  - gRPC service mesh shows all calls returning OK
  - Partners received two batches with different idempotency keys
  - Issue appears to affect some orders but not others (pattern unclear)

# ===========================================================================
# NOISE CONFIGURATION (lighter than CASCADE-012 -- LLM coworkers add difficulty)
# ===========================================================================
noise_config:
  entries_per_source: 50000
  seed: 2026
  time_range_hours: 336
  signal_positions:
    incidents: [2847, 5089, 8127, 12183, 16247, 21312, 27389, 33428, 39502, 44567]
    platform-general: [8847, 19234, 35567]
    sre-ops: [12423, 28891, 41567]
    backend-eng: [7234, 18678, 31456]
    deploys: [5156, 14489, 26892, 38234]
    alerts: [9234, 21567, 34890, 46234]
    fulfillment: [11123, 24456, 37789]
    support: [6089, 17234, 29567]
    order-processing-service: [15234, 28567, 40891, 47123]
    inventory-service: [12891, 26678, 39345]
    fulfillment-gateway: [9567, 22234, 36891]
    storefront-api: [14234, 31891]
    batch-builder: [16234, 29567, 41023]

# ===========================================================================
# SLACK MCP SERVER
# ===========================================================================
slack:
  channels:
    - name: "#incidents"
      messages:
        - user: "bot: pagerduty"
          timestamp: "2026-02-07T13:47:00Z"
          text: "[FIRING] StorefrontCircuitBreaker: inventory-service returning negative stock for >50 SKUs. Circuit breaker OPEN. Storefront offline."

        - user: "alicia (SRE on-call)"
          timestamp: "2026-02-07T13:48:00Z"
          text: "Ack'd. Looking at it now. Storefront is completely down -- circuit breaker tripped on inventory-service. 847 SKUs with negative stock."

        - user: "lisa (support lead)"
          timestamp: "2026-02-07T13:50:00Z"
          text: "Partners are calling in. ShipCo says they received duplicate order batches. FastFreight and PackLogic reporting the same. We have 120+ support tickets already."

        - user: "frank (devops)"
          timestamp: "2026-02-07T13:52:00Z"
          text: "All pods healthy. No OOM kills, no restarts, no deploys today. kubectl looks completely clean. Health checks passing everywhere."

        - user: "dan (backend eng)"
          timestamp: "2026-02-07T13:54:00Z"
          text: "Looking at webhook logs. Orders are being sent to partners TWICE. The idempotency keys are different between the two sends -- they're timestamp-based so the 5-minute gap generates different keys."

        - user: "tyler (junior eng)"
          timestamp: "2026-02-07T13:55:00Z"
          text: "Double shipments?? Is it the database? Maybe we have a replication lag issue causing duplicate reads?"

        - user: "dan (backend eng)"
          timestamp: "2026-02-07T13:57:00Z"
          text: "Not the database. The webhook dispatch log shows two separate dispatch events for the same order IDs. The first at 13:42, the second at 13:47. Different idempotency keys both times."

        - user: "alicia (SRE on-call)"
          timestamp: "2026-02-07T13:59:00Z"
          text: "All gRPC health checks passing. Service mesh shows 100% OK status across the board. No errors anywhere in the gRPC layer. This is confusing -- if orders are being duplicated it should show up as errors somewhere."

        - user: "priya (fulfillment eng)"
          timestamp: "2026-02-07T14:01:00Z"
          text: "I'm looking at the affected orders. Can't find a clear pattern yet. Some batches are fine, some have the issue. Still digging through the dispatch logs."

        - user: "dan (backend eng)"
          timestamp: "2026-02-07T14:03:00Z"
          text: "The webhook refactor last month changed idempotency keys from UUIDs to timestamps. That's why the two sends have different keys -- the partner can't dedup them. I bet the refactor introduced a retry bug."

        - user: "tyler (junior eng)"
          timestamp: "2026-02-07T14:04:00Z"
          text: "What if it's a race condition in the webhook dispatch? Maybe two workers are picking up the same batch?"

        - user: "priya (fulfillment eng)"
          timestamp: "2026-02-07T14:06:00Z"
          text: "I checked the dispatch queue. Each batch only appears once. It's not a duplicate in the queue -- something is causing the same batch to be processed through two different code paths."

        - user: "dan (backend eng)"
          timestamp: "2026-02-07T14:08:00Z"
          text: "Found it. The idempotency key format change on Jan 23 is the root cause. Timestamp-based keys generate different keys on retry. I can reproduce it locally. Proposing fix now."

        - user: "alicia (SRE on-call)"
          timestamp: "2026-02-07T14:10:00Z"
          text: "Nice find Dan. But why are orders being retried in the first place? The initial dispatch should be the only one."

        - user: "dan (backend eng)"
          timestamp: "2026-02-07T14:12:00Z"
          text: "The async retry logic from the webhook refactor. When the webhook fires, if the response comes back slow, the retry kicks in. With UUID keys the partner would dedup, but timestamp keys are unique per attempt. That's the bug."

        - user: "frank (devops)"
          timestamp: "2026-02-07T14:14:00Z"
          text: "Can we just reset the circuit breaker and turn the storefront back on? Lisa is saying the CFO is asking for an ETA."

        - user: "alicia (SRE on-call)"
          timestamp: "2026-02-07T14:15:00Z"
          text: "No. If we turn it back on with negative inventory, customers will order items we don't have. We need to understand WHY inventory went negative first."

        - user: "dan (backend eng)"
          timestamp: "2026-02-07T14:18:00Z"
          text: "I can reproduce the duplicate dispatch locally. When the async retry fires, it generates a new timestamp-based idempotency key. Partner accepts both because the keys are different. This is the root cause. I'm writing the fix now -- switch back to UUID-based keys."

        - user: "priya (fulfillment eng)"
          timestamp: "2026-02-07T14:22:00Z"
          text: "Wait, I also found messages in the RabbitMQ dead letter queue. The TTL policy change last week could be reprocessing expired messages. That could also explain duplicates."

        - user: "dan (backend eng)"
          timestamp: "2026-02-07T14:24:00Z"
          text: "Priya, I already reproduced it with the idempotency key bug. We found it, let's fix it and move on. The DLQ thing is a separate issue."

        - user: "tyler (junior eng)"
          timestamp: "2026-02-07T14:26:00Z"
          text: "I've been checking DNS TTLs for the last 30 minutes. The DNS resolver cache on prod-node-07 has a stale entry. Could be causing requests to go to the wrong endpoint?"

        - user: "alicia (SRE on-call)"
          timestamp: "2026-02-07T14:28:00Z"
          text: "Tyler, I don't think DNS is related. Dan, your fix makes sense. But I'm also handling a SEV-2 on the recommendation service that started 20 minutes ago. The rec service is throwing errors too -- could these be related?"

    - name: "#platform-general"
      messages:
        - user: "bot: ci-notify"
          timestamp: "2026-01-22T09:15:00Z"
          text: "Build passed: storefront-api #412 (main)"

        - user: "bot: deploy-notify"
          timestamp: "2026-01-23T14:30:00Z"
          text: "Deploy complete: order-processing-service v3.8.1 -> v3.8.2 (webhook refactor)"

        - user: "kevin (SRE)"
          timestamp: "2026-01-24T10:45:00Z"
          text: "applied ansible tuning playbook across cluster nodes. saving ~2GB RAM per host. tested with standard load test suite, looks good."

        - user: "bot: ansible"
          timestamp: "2026-01-24T10:47:00Z"
          text: "Playbook complete: host_optimization.yml applied to 12 nodes. 30 sysctl parameters updated. No errors."

        - user: "frank (devops)"
          timestamp: "2026-01-25T09:00:00Z"
          text: "Nice savings on the memory, kevin. Every bit helps with our infra budget."

        - user: "priya (fulfillment eng)"
          timestamp: "2026-02-01T11:30:00Z"
          text: "Reminder: fulfillment webhook idempotency key format changed from UUID to timestamp in v3.8.2. Partners have been notified."

        - user: "bot: deploy-notify"
          timestamp: "2026-02-04T16:00:00Z"
          text: "Deploy complete: frontend v4.12.0 (minor UI updates)"

    - name: "#sre-ops"
      messages:
        - user: "kevin (SRE)"
          timestamp: "2026-01-24T10:30:00Z"
          text: "Deploying production host memory optimization phase 2. Applying ansible tuning playbook to reduce memory footprint. Should save ~2GB per host."

        - user: "kevin (SRE)"
          timestamp: "2026-01-24T10:50:00Z"
          text: "Playbook deployed. Ran standard load test suite -- no issues. API latency unchanged. Memory usage dropped 2.1GB per host. All green."

        - user: "alicia (SRE on-call)"
          timestamp: "2026-01-24T11:00:00Z"
          text: "Cool, how many parameters did you change?"

        - user: "kevin (SRE)"
          timestamp: "2026-01-24T11:05:00Z"
          text: "About 30 sysctl params. Standard tuning profile from the wiki. Nothing exotic."

        - user: "alicia (SRE on-call)"
          timestamp: "2026-01-24T11:10:00Z"
          text: "ok sounds good. nice memory savings."

    - name: "#backend-eng"
      messages:
        - user: "dan (backend eng)"
          timestamp: "2026-01-23T14:00:00Z"
          text: "Webhook refactor PR merged. Key changes: idempotency keys now timestamp-based, batch dispatch is now async with retry, hold_for_review check moved to the gRPC stream consumer."

        - user: "priya (fulfillment eng)"
          timestamp: "2026-01-23T14:15:00Z"
          text: "Verified the partner integration tests pass. ShipCo test endpoint accepted the new key format."

        - user: "dan (backend eng)"
          timestamp: "2026-02-05T10:00:00Z"
          text: "Seeing intermittent auto-approval of orders that should be held for review. Can't reproduce. Happens randomly 2-3 times per day."

        - user: "priya (fulfillment eng)"
          timestamp: "2026-02-05T10:15:00Z"
          text: "Could be a race condition in the approval pipeline? I've seen timing issues before."

        - user: "dan (backend eng)"
          timestamp: "2026-02-05T10:20:00Z"
          text: "Maybe. I'll keep an eye on it. Not blocking anything right now."

    - name: "#fulfillment"
      messages:
        - user: "priya (fulfillment eng)"
          timestamp: "2026-02-07T13:55:00Z"
          text: "CRITICAL: ShipCo, FastFreight, and PackLogic all reporting duplicate order batches. They've already shipped both. We need to stop outbound webhooks NOW."

        - user: "priya (fulfillment eng)"
          timestamp: "2026-02-07T14:00:00Z"
          text: "Killed the webhook dispatcher. No more outbound batches. But the damage is done -- partners shipped 847 duplicate orders across all three partners."

        - user: "priya (fulfillment eng)"
          timestamp: "2026-02-07T14:20:00Z"
          text: "I checked the RabbitMQ dead letter queue and there are messages in it. The queue policy change last week added TTL and dead letter routing. Could DLQ reprocessing be creating duplicates?"

    - name: "#deploys"
      messages:
        - user: "bot: deploy-notify"
          timestamp: "2026-01-20T09:00:00Z"
          text: "Deploy: inventory-service v2.4.0 -> v2.4.1 (batch reservation optimization)"

        - user: "bot: deploy-notify"
          timestamp: "2026-01-22T14:00:00Z"
          text: "Deploy: fulfillment-gateway v1.9.3 -> v1.9.4 (retry logic improvements)"

        - user: "bot: deploy-notify"
          timestamp: "2026-01-23T14:35:00Z"
          text: "Deploy: order-processing-service v3.8.1 -> v3.8.2 (webhook refactor, idempotency key change)"

        - user: "bot: ansible"
          timestamp: "2026-01-24T10:47:00Z"
          text: "Ansible: host_optimization.yml applied to prod-node-{01..12}. 30 sysctl parameters updated. All 847 tests passed. Deployment successful."

        - user: "bot: deploy-notify"
          timestamp: "2026-01-28T11:00:00Z"
          text: "Deploy: storefront-api v2.1.0 -> v2.1.1 (circuit breaker threshold adjustment)"

        - user: "bot: deploy-notify"
          timestamp: "2026-01-30T16:00:00Z"
          text: "Deploy: payment-service v3.5.2 -> v3.5.3 (PCI compliance patch)"

        - user: "bot: deploy-notify"
          timestamp: "2026-02-01T10:00:00Z"
          text: "Deploy: order-processing-service v3.8.2 -> v3.8.3 (logging improvements)"

        - user: "bot: deploy-notify"
          timestamp: "2026-02-03T09:30:00Z"
          text: "Deploy: recommendation-service v1.7.0 -> v1.7.1 (model update)"

        - user: "bot: deploy-notify"
          timestamp: "2026-02-04T16:00:00Z"
          text: "Deploy: frontend v4.12.0 (minor UI updates)"

        - user: "bot: deploy-notify"
          timestamp: "2026-02-05T11:00:00Z"
          text: "Deploy: cart-service v2.3.0 -> v2.3.1 (Redis connection pool tuning)"

    - name: "#alerts"
      messages:
        - user: "bot: grafana-alerting"
          timestamp: "2026-02-05T03:00:00Z"
          text: "[RESOLVED] HighMemory: recommendation-service memory above 80% for 5m. Resolved after GC."

        - user: "bot: pagerduty"
          timestamp: "2026-02-06T14:20:00Z"
          text: "[RESOLVED] HighLatency: fulfillment-gateway P99 > 2s. Duration: 4m. Auto-resolved."

        - user: "bot: grafana-alerting"
          timestamp: "2026-02-07T13:47:00Z"
          text: "[FIRING] StorefrontCircuitBreaker: inventory-service negative stock count > 50. Current: 847. Storefront circuit breaker OPEN."

        - user: "bot: grafana-alerting"
          timestamp: "2026-02-07T13:48:00Z"
          text: "[FIRING] InventoryNegativeStock: 847 SKUs have negative stock values. Max negative: -234 units (SKU: ELEC-TV-55-SAM)."

        - user: "bot: pagerduty"
          timestamp: "2026-02-07T13:49:00Z"
          text: "[FIRING] FulfillmentDuplicateBatch: duplicate batch IDs detected in webhook dispatch log. 3 partners affected."

    - name: "#support"
      messages:
        - user: "lisa (support lead)"
          timestamp: "2026-02-07T13:50:00Z"
          text: "ShipCo account manager called directly. They shipped duplicate orders and want to know who's paying for the return shipping."

        - user: "lisa (support lead)"
          timestamp: "2026-02-07T13:55:00Z"
          text: "FastFreight and PackLogic also reporting duplicates. This is across ALL our fulfillment partners."

        - user: "lisa (support lead)"
          timestamp: "2026-02-07T14:10:00Z"
          text: "Customer complaints about storefront being down now at 120+. CFO is asking for a customer impact assessment and ETA."

        - user: "lisa (support lead)"
          timestamp: "2026-02-07T14:25:00Z"
          text: "ShipCo says they can't recall the shipments. They're already in transit. We need to figure out a returns process for 847 duplicate orders."

        - user: "lisa (support lead)"
          timestamp: "2026-02-07T14:30:00Z"
          text: "FYI from ShipCo: they updated their webhook acceptance endpoint to v3 API on Jan 25. New endpoint accepts all dispatches regardless of idempotency key format. They say that shouldn't matter since we should only send once."

    - name: "#random"
      messages:
        - user: "tyler (junior eng)"
          timestamp: "2026-02-05T12:30:00Z"
          text: "Anyone tried the new Thai place on Market St? Their pad thai is incredible."

        - user: "frank (devops)"
          timestamp: "2026-02-06T09:00:00Z"
          text: "Monday motivation: at least the servers aren't on fire."

        - user: "dan (backend eng)"
          timestamp: "2026-02-07T08:30:00Z"
          text: "Coffee machine in the 3rd floor kitchen is broken again."

    - name: "#standups"
      messages:
        - user: "dan (backend eng)"
          timestamp: "2026-02-07T09:00:00Z"
          text: "Yesterday: investigated missing hold_for_review flags on some order batches. Couldn't reproduce. Today: continuing investigation. Blocker: none."

        - user: "priya (fulfillment eng)"
          timestamp: "2026-02-07T09:02:00Z"
          text: "Yesterday: partner integration testing for new idempotency key format. Today: monitoring partner webhook delivery rates. Blocker: none."

        - user: "kevin (SRE)"
          timestamp: "2026-02-07T09:04:00Z"
          text: "Yesterday: reviewed memory usage across cluster after tuning playbook. All looking good -- 2GB saved per host. Today: working on Prometheus retention policy. Blocker: none."

# ===========================================================================
# SENTRY MCP SERVER
# ===========================================================================
sentry:
  projects:
    - name: "order-processing-service"
      issues:
        - id: "OPS-1847"
          title: "Webhook dispatch: duplicate batch detected (different idempotency keys)"
          count: 23
          first_seen: "2026-02-07T13:42:00Z"
          last_seen: "2026-02-07T14:15:00Z"
          level: "error"
          tags:
            batch_count: "23"
            partner: "ShipCo, FastFreight, PackLogic"
            note: "Batches sent twice with different timestamp-based idempotency keys"

        - id: "OPS-1848"
          title: "Order auto-approval rate increased 3x in last 2 weeks"
          count: 847
          first_seen: "2026-02-05T08:00:00Z"
          last_seen: "2026-02-07T14:10:00Z"
          level: "warning"
          tags:
            environment: "production"
            note: "Auto-approval rate jumped from ~8/min to ~24/min. Business rules unchanged. Investigating."

    - name: "fulfillment-gateway"
      issues:
        - id: "FG-502"
          title: "Partner webhook returned 409 Conflict (idempotency key mismatch)"
          count: 0
          first_seen: null
          level: "info"
          tags:
            note: "No 409s -- partners accepted both batches because idempotency keys differed"

    - name: "inventory-service"
      issues:
        - id: "INV-934"
          title: "Stock level went negative: SKU ELEC-TV-55-SAM, current: -234"
          count: 847
          first_seen: "2026-02-07T13:44:00Z"
          last_seen: "2026-02-07T13:47:00Z"
          level: "error"
          tags:
            max_negative: "-234"
            sku_count: "847"

    - name: "storefront-api"
      issues:
        - id: "SF-789"
          title: "Circuit breaker OPEN: inventory-service returning negative stock"
          count: 1
          first_seen: "2026-02-07T13:47:00Z"
          level: "critical"
          tags:
            threshold: "50 negative SKUs"
            actual: "847 negative SKUs"
            state: "OPEN"

    # SIGNIFICANT SILENCE: gRPC shows no errors
    - name: "grpc-mesh"
      issues: []

    # SIGNIFICANT SILENCE: No TCP errors anywhere
    - name: "infrastructure-network"
      issues: []

    # SIGNIFICANT SILENCE: protobuf parsing reports no errors
    - name: "protobuf-serialization"
      issues: []

    # Normal services
    - name: "payment-service"
      issues: []

    - name: "cart-service"
      issues:
        - id: "CART-223"
          title: "Redis connection timeout during health check"
          count: 3
          first_seen: "2026-02-06T22:00:00Z"
          level: "warning"
          tags:
            note: "Transient Redis blip overnight, auto-resolved"

    - name: "storefront-frontend"
      issues:
        - id: "SFE-445"
          title: "503 Service Unavailable from storefront-api"
          count: 3420
          first_seen: "2026-02-07T13:47:00Z"
          level: "error"
          tags:
            note: "Consequence of circuit breaker being open"

    - name: "recommendation-service"
      issues:
        - id: "REC-178"
          title: "Model refresh cache miss: stale recommendations served"
          count: 12
          first_seen: "2026-02-06T06:00:00Z"
          level: "warning"
          tags:
            note: "Unrelated -- model cache TTL issue from yesterday"

    # DISTRACTOR: pre-existing issues
    - name: "email-service"
      issues:
        - id: "EMAIL-089"
          title: "SMTP connection pool exhaustion under high volume"
          count: 5
          first_seen: "2026-02-03T14:00:00Z"
          level: "warning"
          tags:
            note: "Known issue, being tracked in JIRA"

    # PLAUSIBLE WRONG ROOT CAUSE 1: Kernel upgrade
    - name: "infrastructure-compute"
      issues:
        - id: "INFRA-3200"
          title: "Kubernetes node kernel upgrade (5.15 -> 6.1) on 3 nodes completed Jan 26"
          count: 1
          first_seen: "2026-01-26T04:00:00Z"
          level: "info"
          tags:
            nodes: "prod-node-04, prod-node-07, prod-node-11"
            note: "Kernel 6.1 has different TCP stack behavior, new MPTCP support, changed default congestion control. Rolled out to 3 of 12 nodes."
            change_window: "2026-01-26 04:00 - 06:00 UTC"

    # PLAUSIBLE WRONG ROOT CAUSE 2: RabbitMQ DLQ
    - name: "message-queue"
      issues:
        - id: "MQ-445"
          title: "RabbitMQ queue policy change - added message TTL and dead letter routing"
          count: 1
          first_seen: "2026-01-27T15:00:00Z"
          level: "info"
          tags:
            queues: "order-dispatch, fulfillment-batch, webhook-outbound"
            ttl_ms: "300000"
            dlq: "dead-letter-exchange"
            note: "Added 5-minute TTL and DLQ routing to prevent queue buildup. Messages that expire are routed to dead letter exchange for reprocessing."

    # PLAUSIBLE WRONG ROOT CAUSE 3: Partner API change
    - name: "partner-integrations"
      issues:
        - id: "PARTNER-112"
          title: "ShipCo updated webhook acceptance endpoint to v3 API on Jan 25"
          count: 1
          first_seen: "2026-01-25T09:00:00Z"
          level: "info"
          tags:
            partner: "ShipCo"
            note: "ShipCo v3 API accepts all dispatches regardless of idempotency key format. They deprecated idempotency validation in v3. FastFreight and PackLogic also migrated to similar v3 endpoints."

# ===========================================================================
# PAGERDUTY MCP SERVER
# ===========================================================================
pagerduty:
  incidents:
    - id: "PD-78901"
      title: "StorefrontCircuitBreaker: inventory-service negative stock"
      urgency: "high"
      status: "triggered"
      created_at: "2026-02-07T13:47:00Z"
      service: "storefront-api"
      timeline:
        - timestamp: "2026-02-07T13:47:00Z"
          action: "Alert triggered"
          detail: "inventory-service returning negative stock for 847 SKUs. Circuit breaker OPEN."
        - timestamp: "2026-02-07T13:48:00Z"
          action: "Acknowledged by alicia"

    - id: "PD-78902"
      title: "FulfillmentDuplicateBatch: duplicate batch IDs in webhook log"
      urgency: "high"
      status: "triggered"
      created_at: "2026-02-07T13:49:00Z"
      service: "fulfillment-gateway"
      timeline:
        - timestamp: "2026-02-07T13:49:00Z"
          action: "Alert triggered"
          detail: "23 duplicate batch dispatches detected. 3 partners affected."
        - timestamp: "2026-02-07T13:50:00Z"
          action: "Acknowledged by priya"

    - id: "PD-78890"
      title: "[RESOLVED] HighLatency: fulfillment-gateway P99 > 2s"
      urgency: "medium"
      status: "resolved"
      created_at: "2026-02-06T14:20:00Z"
      resolved_at: "2026-02-06T14:24:00Z"
      service: "fulfillment-gateway"
      timeline:
        - timestamp: "2026-02-06T14:20:00Z"
          action: "Alert triggered"
        - timestamp: "2026-02-06T14:24:00Z"
          action: "Auto-resolved"

# ===========================================================================
# PROMETHEUS / METRICS MCP SERVER
# ===========================================================================
metrics:
  queries:
    # ===================================================================
    # INVENTORY SYMPTOMS (most visible)
    # ===================================================================
    - query: "inventory_negative_stock_skus"
      result:
        current: 847
        1h_ago: 0
        note: "847 SKUs with negative stock. Jumped from 0 to 847 in a 5-minute window."

    - query: "inventory_stock_level{sku='ELEC-TV-55-SAM'}"
      result:
        current: -234
        1h_ago: 412
        note: "Most negative SKU. Was 412 units, now -234."

    - query: "storefront_circuit_breaker_state"
      result:
        current: "OPEN"
        note: "Tripped at 13:47 UTC. Threshold: 50 negative SKUs."

    - query: "storefront_request_rate"
      result:
        current: 0
        1h_ago: 245
        note: "Zero -- storefront is offline"

    # ===================================================================
    # FULFILLMENT / WEBHOOK SYMPTOMS
    # ===================================================================
    - query: "fulfillment_webhook_dispatch_total"
      result:
        current: 46
        1h_ago: 0
        note: "23 batches dispatched twice = 46 total dispatches"

    - query: "fulfillment_webhook_success_rate"
      result:
        current: 1.0
        note: "100% success -- partners accepted all dispatches (no dedup)"

    - query: "fulfillment_webhook_latency_seconds{quantile='0.99'}"
      result:
        current: 0.34
        note: "P99 webhook latency 340ms -- normal"

    - query: "fulfillment_webhook_latency_seconds{quantile='0.50'}"
      result:
        current: 0.18
        note: "P50 webhook latency 180ms -- normal"

    # ===================================================================
    # ORDER PROCESSING METRICS
    # ===================================================================
    - query: "order_hold_for_review_rate"
      result:
        current: 0.0
        24h_ago: 0.31
        note: "0% hold rate now vs normal 31%. All orders auto-approving."

    - query: "order_auto_approved_total"
      result:
        rate_1m: 12.4
        24h_ago_rate: 8.5
        note: "Elevated -- orders that should be held are auto-approving"

    - query: "order_processing_grpc_status{code='OK'}"
      result:
        rate_1m: 12.4
        note: "All gRPC calls returning OK"

    - query: "order_processing_grpc_status{code='Error'}"
      result:
        rate_1m: 0
        note: "Zero gRPC errors -- SIGNIFICANT SILENCE"

    # ===================================================================
    # WEBHOOK DUPLICATE METRIC (supports idempotency key theory)
    # ===================================================================
    - query: "webhook_duplicate_dispatches_total"
      result:
        current: 23
        note: "23 duplicate dispatches detected -- correlates exactly with partner reports"

    - query: "webhook_idempotency_key_collisions"
      result:
        current: 0
        note: "Zero collisions -- each retry generates a unique timestamp key"

    - query: "webhook_retry_attempts_total"
      result:
        current: 23
        note: "23 retries, each generating a new idempotency key due to timestamp format"

    # ===================================================================
    # gRPC METRICS (all look healthy -- significant silence)
    # ===================================================================
    - query: "grpc_server_handled_total{service='order-processing-service',grpc_code='OK'}"
      result:
        rate_1m: 12.4
        note: "All calls OK"

    - query: "grpc_server_handled_total{service='order-processing-service',grpc_code='Internal'}"
      result:
        rate_1m: 0
        note: "Zero internal errors"

    - query: "grpc_server_handled_total{service='order-processing-service',grpc_code='Unavailable'}"
      result:
        rate_1m: 0
        note: "Zero unavailable errors"

    - query: "grpc_server_handling_seconds{service='order-processing-service',quantile='0.99'}"
      result:
        current: 0.45
        note: "Normal latency"

    # ===================================================================
    # TCP/NETWORK METRICS (no errors -- significant silence)
    # ===================================================================
    - query: "node_netstat_Tcp_RetransSegs"
      result:
        rate_1m: 0.2
        note: "Minimal retransmissions -- TCP layer looks healthy"

    - query: "node_netstat_Tcp_InErrs"
      result:
        rate_1m: 0
        note: "Zero TCP input errors"

    - query: "node_netstat_Tcp_OutRsts"
      result:
        rate_1m: 0.1
        note: "Near-zero RST packets"

    - query: "node_network_receive_errs_total{device='eth0'}"
      result:
        rate_1m: 0
        note: "Zero network receive errors"

    - query: "node_network_transmit_errs_total{device='eth0'}"
      result:
        rate_1m: 0
        note: "Zero network transmit errors"

    # ===================================================================
    # INFRASTRUCTURE METRICS (all healthy)
    # ===================================================================
    - query: "node_cpu_seconds_total{mode='idle'}"
      result:
        rate_1m: 0.68
        note: "68% idle -- not CPU constrained"

    - query: "node_memory_MemAvailable_bytes"
      result:
        current: 14000000000
        total: 32000000000
        note: "44% memory available -- improved after recent host optimization (freed ~2GB)"

    - query: "node_filesystem_avail_bytes{mountpoint='/'}"
      result:
        current: 45000000000
        total: 100000000000
        note: "45% disk free -- healthy"

    - query: "container_cpu_usage_seconds_total{pod=~'order-processing-.*'}"
      result:
        rate_1m: 0.15
        note: "Normal CPU"

    - query: "container_memory_working_set_bytes{pod=~'order-processing-.*'}"
      result:
        current: 312000000
        limit: 536870912
        note: "58% memory -- normal"

    - query: "container_cpu_usage_seconds_total{pod=~'inventory-.*'}"
      result:
        rate_1m: 0.08
        note: "Normal"

    - query: "container_cpu_usage_seconds_total{pod=~'fulfillment-.*'}"
      result:
        rate_1m: 0.12
        note: "Normal"

    - query: "container_cpu_usage_seconds_total{pod=~'storefront-.*'}"
      result:
        rate_1m: 0.01
        note: "Near zero -- storefront is rejecting all requests (circuit breaker open)"

    # ===================================================================
    # HEALTHY SERVICE METRICS
    # ===================================================================
    - query: "payment_service_success_rate"
      result:
        current: 0.998
        note: "Payment service healthy"

    - query: "cart_service_request_rate"
      result:
        current: 0
        note: "Zero -- storefront is down so no cart requests"

    - query: "recommendation_service_latency_p99"
      result:
        current: 0.089
        note: "Normal"

    # ===================================================================
    # PROCESS METRICS
    # ===================================================================
    - query: "process_open_fds{service='order-processing-service'}"
      result:
        current: 156
        note: "Normal file descriptor count"

    - query: "go_goroutines{service='order-processing-service'}"
      result:
        current: 48
        note: "Normal goroutine count"

    - query: "go_goroutines{service='inventory-service'}"
      result:
        current: 32
        note: "Normal"

# ===========================================================================
# LOGS MCP SERVER
# ===========================================================================
logs:
  services:
    - name: "order-processing-service"
      signal_position_note: "Byte count entry at position ~40000 in 50K noise entries"
      entries:
        - timestamp: "2026-02-07T13:38:00Z"
          level: "INFO"
          message: "Health check passed. Uptime: 14d 3h 22m."

        - timestamp: "2026-02-07T13:39:00Z"
          level: "INFO"
          message: "Processing batch batch-20260207-1339 with 45 orders, status=OK"

        - timestamp: "2026-02-07T13:39:30Z"
          level: "INFO"
          message: "Batch batch-20260207-1339: auto-approved 31 orders, held 14 for review."

        - timestamp: "2026-02-07T13:40:00Z"
          level: "INFO"
          message: "Processing batch batch-20260207-1340 with 234 orders, status=OK"

        - timestamp: "2026-02-07T13:40:02Z"
          level: "INFO"
          message: "Batch batch-20260207-1340: auto-approved all 234 orders."

        - timestamp: "2026-02-07T13:40:02Z"
          level: "INFO"
          message: "Dispatching webhook to ShipCo: batch=batch-20260207-1340, orders=234, idempotency_key=2026-02-07T13:40:02.123Z"

        - timestamp: "2026-02-07T13:41:00Z"
          level: "INFO"
          message: "Processing batch batch-20260207-1341 with 8 orders, status=OK"

        - timestamp: "2026-02-07T13:41:01Z"
          level: "INFO"
          message: "Batch batch-20260207-1341: auto-approved 5 orders, held 3 for review."

        - timestamp: "2026-02-07T13:42:00Z"
          level: "INFO"
          message: "Processing batch batch-20260207-1342 with 613 orders, status=OK"

        - timestamp: "2026-02-07T13:42:01Z"
          level: "INFO"
          message: "Batch batch-20260207-1342: auto-approved all 613 orders."

        - timestamp: "2026-02-07T13:42:02Z"
          level: "INFO"
          message: "Dispatching webhook to FastFreight: batch=batch-20260207-1342, orders=613"

        - timestamp: "2026-02-07T13:43:00Z"
          level: "INFO"
          message: "Processing batch batch-20260207-1343-small with 12 orders, status=OK"

        - timestamp: "2026-02-07T13:43:01Z"
          level: "INFO"
          message: "Batch batch-20260207-1343-small: auto-approved 8 orders, held 4 for review."

        - timestamp: "2026-02-07T13:44:00Z"
          level: "INFO"
          message: "GC pause 12ms. Heap: 289MB allocated, 512MB limit."

        - timestamp: "2026-02-07T13:44:30Z"
          level: "INFO"
          message: "Connection pool stats: active=12, idle=36, max=100"

        - timestamp: "2026-02-07T13:45:00Z"
          level: "WARN"
          message: "Batch batch-20260207-1340 re-entered processing pipeline via retry. Previous dispatch at 13:40. New idempotency_key=2026-02-07T13:45:00.456Z"

        - timestamp: "2026-02-07T13:45:01Z"
          level: "INFO"
          message: "Dispatching webhook to ShipCo: batch=batch-20260207-1340 (retry), orders=234, idempotency_key=2026-02-07T13:45:00.456Z"

        - timestamp: "2026-02-07T13:46:00Z"
          level: "INFO"
          message: "Processing batch batch-20260207-1346 with 22 orders, status=OK"

        - timestamp: "2026-02-07T13:46:01Z"
          level: "INFO"
          message: "Batch batch-20260207-1346: auto-approved 15 orders, held 7 for review."

        - timestamp: "2026-02-07T13:47:00Z"
          level: "WARN"
          message: "Batch batch-20260207-1342 re-entered processing pipeline via retry. Previous dispatch at 13:42."

        # BURIED SIGNAL: byte count with different field name (msg_recv_sz)
        # This is at position ~40000 in the noise-generated log stream
        - timestamp: "2026-02-07T13:40:01Z"
          level: "DEBUG"
          message: "Batch batch-a8f3c21e received: msg_recv_sz=4194304, unmarshal_ok=true, orders_parsed=612"

    - name: "inventory-service"
      entries:
        - timestamp: "2026-02-07T13:38:00Z"
          level: "INFO"
          message: "Health check passed. Stock sync: 12,847 SKUs tracked."

        - timestamp: "2026-02-07T13:39:00Z"
          level: "INFO"
          message: "Stock reservation: batch-20260207-1339, 45 items reserved"

        - timestamp: "2026-02-07T13:40:03Z"
          level: "INFO"
          message: "Stock reservation: batch-20260207-1340, 234 items reserved"

        - timestamp: "2026-02-07T13:41:03Z"
          level: "INFO"
          message: "Stock reservation: batch-20260207-1341, 8 items reserved"

        - timestamp: "2026-02-07T13:42:03Z"
          level: "INFO"
          message: "Stock reservation: batch-20260207-1342, 613 items reserved"

        - timestamp: "2026-02-07T13:43:03Z"
          level: "INFO"
          message: "Stock reservation: batch-20260207-1343-small, 12 items reserved"

        - timestamp: "2026-02-07T13:44:00Z"
          level: "INFO"
          message: "Reservation stats: 912 items reserved in last 5m, 0 failures"

        - timestamp: "2026-02-07T13:45:02Z"
          level: "WARN"
          message: "Stock reservation: batch-20260207-1340 (duplicate reservation attempt), 234 items -- stock going NEGATIVE for 89 SKUs"

        - timestamp: "2026-02-07T13:46:00Z"
          level: "INFO"
          message: "Reservation stats: 1146 items reserved in last 5m, 89 negative stock warnings"

        - timestamp: "2026-02-07T13:47:02Z"
          level: "ERROR"
          message: "Stock reservation: batch-20260207-1342 (duplicate reservation attempt), 613 items -- stock NEGATIVE for 847 SKUs. Max negative: -234 (ELEC-TV-55-SAM)"

        - timestamp: "2026-02-07T13:47:03Z"
          level: "CRITICAL"
          message: "Circuit breaker threshold exceeded: 847 negative-stock SKUs > threshold 50. Reporting UNHEALTHY to storefront-api."

    - name: "fulfillment-gateway"
      entries:
        - timestamp: "2026-02-07T13:40:03Z"
          level: "INFO"
          message: "Webhook POST to ShipCo: batch=batch-20260207-1340, status=202 Accepted, response_time=340ms"

        - timestamp: "2026-02-07T13:42:03Z"
          level: "INFO"
          message: "Webhook POST to FastFreight: batch=batch-20260207-1342, status=202 Accepted, response_time=280ms"

        - timestamp: "2026-02-07T13:45:02Z"
          level: "INFO"
          message: "Webhook POST to ShipCo: batch=batch-20260207-1340 (retry), status=202 Accepted, response_time=310ms"

        - timestamp: "2026-02-07T13:47:02Z"
          level: "INFO"
          message: "Webhook POST to FastFreight: batch=batch-20260207-1342 (retry), status=202 Accepted, response_time=295ms"

        - timestamp: "2026-02-07T13:47:03Z"
          level: "INFO"
          message: "All webhook dispatches completed successfully. No errors."

    - name: "storefront-api"
      entries:
        - timestamp: "2026-02-07T13:47:03Z"
          level: "ERROR"
          message: "Circuit breaker OPEN for inventory-service. Returning 503 for all storefront requests."

        - timestamp: "2026-02-07T13:47:04Z"
          level: "INFO"
          message: "Draining in-flight requests. 34 requests returned 503."

    - name: "batch-builder"
      signal_position_note: "Byte count entry at position ~41000 in 50K noise entries"
      entries:
        - timestamp: "2026-02-07T13:38:00Z"
          level: "INFO"
          message: "Health check passed. Queue depth: 47 batches pending."

        - timestamp: "2026-02-07T13:39:00Z"
          level: "INFO"
          message: "Building batch batch-20260207-1339: 45 orders, sending to order-processing-service"

        - timestamp: "2026-02-07T13:39:30Z"
          level: "INFO"
          message: "Batch batch-20260207-1339 dispatched, status=sent"

        - timestamp: "2026-02-07T13:39:59Z"
          level: "INFO"
          message: "Building batch batch-20260207-1340: 234 orders, sending to order-processing-service"

        - timestamp: "2026-02-07T13:40:00Z"
          level: "INFO"
          message: "Batch batch-20260207-1340 dispatched, status=sent"

        - timestamp: "2026-02-07T13:41:59Z"
          level: "INFO"
          message: "Building batch batch-20260207-1342: 613 orders, sending to order-processing-service"

        - timestamp: "2026-02-07T13:42:00Z"
          level: "INFO"
          message: "Batch batch-20260207-1342 dispatched, status=sent"

        - timestamp: "2026-02-07T13:43:00Z"
          level: "INFO"
          message: "Building batch batch-20260207-1343-small: 12 orders, sending to order-processing-service"

        - timestamp: "2026-02-07T13:43:01Z"
          level: "INFO"
          message: "Batch batch-20260207-1343-small dispatched, status=sent"

        - timestamp: "2026-02-07T13:44:00Z"
          level: "INFO"
          message: "Queue stats: processed=12, pending=35, errors=0"

        # BURIED SIGNAL: byte count with different field name (payload_wire_bytes)
        # This is at position ~41000 in the noise-generated log stream
        - timestamp: "2026-02-07T13:40:00Z"
          level: "DEBUG"
          message: "Batch batch-a8f3c21e dispatched: orders=847, payload_wire_bytes=6841344, destination=order-processing-service, status=sent"

    # Kernel/system logs -- normal boot messages, no errors
    - name: "system-kernel"
      entries:
        - timestamp: "2026-02-07T13:00:00Z"
          level: "INFO"
          message: "kernel: Booting with 32GB RAM, 16 cores"

        - timestamp: "2026-02-07T13:00:00Z"
          level: "INFO"
          message: "kernel: ACPI: Power management enabled"

        - timestamp: "2026-02-07T13:00:01Z"
          level: "INFO"
          message: "kernel: net.core.somaxconn = 65535"

        - timestamp: "2026-02-07T13:00:01Z"
          level: "INFO"
          message: "kernel: net.ipv4.tcp_max_syn_backlog = 65535"

        - timestamp: "2026-02-07T13:00:02Z"
          level: "INFO"
          message: "kernel: eth0: link up, 10Gbps full duplex"

        - timestamp: "2026-02-07T13:00:03Z"
          level: "INFO"
          message: "kernel: sysctl parameters loaded from /etc/sysctl.d/*.conf"

# ===========================================================================
# FEATURE FLAGS
# ===========================================================================
feature_flags:
  - flag: "fulfillment_webhook_async"
    current_value: true
    state: "ENABLED"
    last_modified: "2026-01-23T14:30:00Z"

  - flag: "order_hold_for_review_enabled"
    current_value: true
    state: "ENABLED"
    last_modified: "2025-11-15T10:00:00Z"

  - flag: "storefront_circuit_breaker_enabled"
    current_value: true
    state: "ENABLED"
    last_modified: "2026-01-28T11:00:00Z"

  - flag: "idempotency_key_format_v2"
    current_value: true
    state: "ENABLED"
    last_modified: "2026-01-23T14:30:00Z"

  - flag: "batch_retry_enabled"
    current_value: true
    state: "ENABLED"
    last_modified: "2026-01-22T14:00:00Z"

# ===========================================================================
# GIT MCP SERVER
# ===========================================================================
git:
  commits:
    - hash: "a1b2c3d"
      author: "kevin.park"
      date: "2026-01-24T10:30:00Z"
      message: "infra: production host memory optimization - phase 2"
      files:
        - "ansible/roles/host_optimization/tasks/main.yml"
        - "ansible/roles/host_optimization/templates/sysctl-tuning.conf.j2"

    - hash: "d4e5f6g"
      author: "dan.rogers"
      date: "2026-01-23T14:00:00Z"
      message: "feat: refactor webhook dispatch with timestamp idempotency keys"
      files:
        - "services/order-processing/webhook_dispatch.go"
        - "services/order-processing/idempotency.go"
        - "services/fulfillment-gateway/dispatch.go"

    - hash: "h7i8j9k"
      author: "priya.sharma"
      date: "2026-01-22T14:00:00Z"
      message: "fix: improve fulfillment retry logic with backoff"
      files:
        - "services/fulfillment-gateway/retry.go"
        - "services/fulfillment-gateway/config.go"

    - hash: "l0m1n2o"
      author: "frank.martinez"
      date: "2026-01-28T11:00:00Z"
      message: "chore: adjust circuit breaker threshold for inventory service"
      files:
        - "services/storefront-api/circuit_breaker.go"

    - hash: "p3q4r5s"
      author: "dan.rogers"
      date: "2026-02-01T10:00:00Z"
      message: "chore: add structured logging to order processing"
      files:
        - "services/order-processing/logging.go"
        - "services/order-processing/main.go"

    - hash: "t6u7v8w"
      author: "tyler.nguyen"
      date: "2026-02-03T09:30:00Z"
      message: "feat: update recommendation model to v1.7.1"
      files:
        - "services/recommendation/model_config.yaml"

    - hash: "x9y0z1a"
      author: "frank.martinez"
      date: "2026-02-04T16:00:00Z"
      message: "chore: frontend v4.12.0 minor UI updates"
      files:
        - "frontend/src/pages/checkout.tsx"
        - "frontend/src/components/cart.tsx"

    - hash: "b2c3d4e"
      author: "dan.rogers"
      date: "2026-02-05T11:00:00Z"
      message: "fix: tune Redis connection pool for cart service"
      files:
        - "services/cart/redis_config.go"

    - hash: "f5g6h7i"
      author: "priya.sharma"
      date: "2026-01-30T16:00:00Z"
      message: "security: PCI compliance patch for payment service"
      files:
        - "services/payment/encryption.go"
        - "services/payment/audit_log.go"

    - hash: "j8k9l0m"
      author: "kevin.park"
      date: "2026-01-20T09:00:00Z"
      message: "perf: optimize inventory batch reservation"
      files:
        - "services/inventory/batch_reserve.go"

  blame:
    "ansible/roles/host_optimization/templates/sysctl-tuning.conf.j2":
      - line: 1
        hash: "a1b2c3d"
        author: "kevin.park"
        date: "2026-01-24T10:30:00Z"
        content: "# Host Memory Optimization Phase 2 - saves ~2GB per host"

      - line: 2
        hash: "a1b2c3d"
        author: "kevin.park"
        date: "2026-01-24T10:30:00Z"
        content: "# Applied standard tuning profile from ops wiki"

      - line: 3
        hash: "a1b2c3d"
        author: "kevin.park"
        date: "2026-01-24T10:30:00Z"
        content: "# 30 sysctl parameters tuned for memory efficiency"

      - line: 4
        hash: "a1b2c3d"
        author: "kevin.park"
        date: "2026-01-24T10:30:00Z"
        content: "# See ops wiki: /runbooks/host-optimization for parameter list"

      - line: 5
        hash: "a1b2c3d"
        author: "kevin.park"
        date: "2026-01-24T10:30:00Z"
        content: "net.core.somaxconn = 65535"

    "services/order-processing/webhook_dispatch.go":
      - line: 47
        hash: "d4e5f6g"
        author: "dan.rogers"
        date: "2026-01-23T14:00:00Z"
        content: "idempotencyKey := fmt.Sprintf(\"%s-%s\", batchID, time.Now().UTC().Format(time.RFC3339Nano))"

      - line: 48
        hash: "d4e5f6g"
        author: "dan.rogers"
        date: "2026-01-23T14:00:00Z"
        content: "// Timestamp-based keys for better traceability in partner logs"
